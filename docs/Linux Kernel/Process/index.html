<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Linux Kernel/Process" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Process &amp; Program | My Sitess</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/docs/Linux Kernel/Process"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Process &amp; Program | My Sitess"><meta data-rh="true" name="description" content="Process"><meta data-rh="true" property="og:description" content="Process"><link data-rh="true" rel="icon" href="/img/image.svg"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/docs/Linux Kernel/Process"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Linux Kernel/Process" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Linux Kernel/Process" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Process & Program","item":"https://your-docusaurus-site.example.com/docs/Linux Kernel/Process"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Sitess RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Sitess Atom Feed"><link rel="stylesheet" href="/assets/css/styles.fdc3fc28.css">
<script src="/assets/js/runtime~main.b05a0db7.js" defer="defer"></script>
<script src="/assets/js/main.54346240.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/head.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/head.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/head.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Joseph Huang</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Column Base DBMS/B-link-tree">Notes</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/Column Base DBMS/B-link-tree">Column Base DBMS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/FreeRTOS/Initialization Macro">FreeRTOS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/Linux Kernel/Process">Linux Kernel</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Linux Kernel/Process">Process &amp; Program</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/Multi-Core Programming/Log System">Multi-Core Programming</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/RISC-V ISA/Cache">RISC-V ISA</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Linux Kernel</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Process &amp; Program</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Process &amp; Program</h1></header>
<p><strong>Process</strong></p>
<blockquote>
<p><strong>Processes are often called tasks or threads in the Linux source code.</strong></p>
<p>摘錄自 Understanding The Linux Kernel</p>
</blockquote>
<blockquote>
<p><strong>The process is the major OS abstraction of a running program. At any point in time, the process can be described by its state: &quot;the contents of memory in its address space&quot;, &quot;the contents of CPU registers (including the program counter and stack pointer, among others)&quot;, and &quot;information about I/O (such as open files which can be read or written)&quot;.</strong></p>
<p>摘錄自 The Abstraction: The Process</p>
</blockquote>
<p><strong>Program</strong></p>
<blockquote>
<p>The <strong>program itself is a lifeless thing: it just sits there on the disk</strong>, a bunch of instructions (and maybe some static data), waiting to spring into action.</p>
<p>摘錄自 The Abstraction: The Process</p>
</blockquote>
<h1>與 Process 相關的議題</h1>
<ul>
<li>context switch</li>
<li>time-sharing &amp; space-sharing</li>
<li>scheduling policy</li>
</ul>
<h1>Processes, Lightweight Processes, and Threads</h1>
<p><strong>Process</strong> 為某一 <strong>Program（可執行檔: elf、exe）</strong> 載入至記憶體中執行的稱呼。</p>
<p>根據不同系統(OS)，Process有會有不同的實作與定義，這邊將以Linux process為範例。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="process">Process<a href="#process" class="hash-link" aria-label="Direct link to Process" title="Direct link to Process">​</a></h2>
<p>在 Linux 中 Process 可以想像成<strong>一種複雜的資料結構結合體</strong>，用來記錄與描述 Process 的狀態，</p>
<p><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/sched.h#L743" target="_blank" rel="noopener noreferrer">task_structure</a> 為 Linux 中用來表示 Process的結構。</p>
<p>它也有親屬關係，每一個 Process 透過一位先輩節點誕生，它也可以有多個同輩節點。</p>
<blockquote>
<p>When a process is created, it is <strong>almost identical</strong> to its parent. <strong>It receives a (logical) copy of the parent’s address space</strong> and <strong>executes the same code as the parent</strong>, beginning at the next instruction following the process creation system call.</p>
<p>Although the parent and child may share the pages containing the program code (text), <strong>they have separate copies of the data (stack and heap)</strong>, so that changes by the child to a memory location are invisible to the parent (and vice versa).</p>
<p>摘錄自 Understanding The Linux Kernel</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="構成-process-的元素們">構成 Process 的元素們<a href="#構成-process-的元素們" class="hash-link" aria-label="Direct link to 構成 Process 的元素們" title="Direct link to 構成 Process 的元素們">​</a></h3>
<p><strong>Memory</strong></p>
<blockquote>
<p><strong>Thus the memory that the process can address (called its address space) is part of the process.</strong></p>
<p>摘錄自 The Abstraction: The Process</p>
</blockquote>
<p><strong>Register</strong></p>
<blockquote>
<p><strong>Also part of the process’s machine state are registers; many instructions explicitly read or update registers and thus clearly they are important to the execution of the process.</strong></p>
<p>摘錄自 The Abstraction: The Process</p>
</blockquote>
<p><strong>I/O Device</strong></p>
<blockquote>
<p><strong>Finally, programs often access persistent storage devices too. Such I/O information might include a list of the files the process currently has open.</strong></p>
<p>摘錄自 The Abstraction: The Process</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="differ-between-new-process--parent">Differ between new process &amp; parent<a href="#differ-between-new-process--parent" class="hash-link" aria-label="Direct link to Differ between new process &amp; parent" title="Direct link to Differ between new process &amp; parent">​</a></h3>
<p>在更改資料前，除了 <strong>PID (process ID)</strong> 、 <strong>PPID (parent process ID)</strong> 等一些用來分辨 process 的 unique ID 需要不同之外其他與 parent process 無異。</p>
<p>在資料更改後（根據採用的實作技術會有不同情景），這邊以 <strong>COW</strong> 為範例。new process 會繼承父親的資料，如 <strong>open file table</strong> 抖，並在這之上加上自身所做的修改。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="thread">Thread<a href="#thread" class="hash-link" aria-label="Direct link to Thread" title="Direct link to Thread">​</a></h2>
<blockquote>
<p><strong>The Linux kernel does not provide any special scheduling semantics or data structures to represent threads. Instead, a thread is merely a process that shares certain resources with other processes.</strong></p>
<p>摘錄自 Understanding The Linux Kernel</p>
</blockquote>
<blockquote>
<p><strong>A thread, defined as a single flow of execution, is linked with a stack
and a set of CPU registers, with the stack pointer and program counter being the
most significant.</strong></p>
<p>摘錄自 lkmpg</p>
</blockquote>
<p>在Linux Kernel中最基本的執行單位就是thread (lightweight process)。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="differ-between-thread--process">Differ between thread &amp; process<a href="#differ-between-thread--process" class="hash-link" aria-label="Direct link to Differ between thread &amp; process" title="Direct link to Differ between thread &amp; process">​</a></h2>
<p>這裡會透過<code>clone()</code>試著去分析兩者之間的差異，因為在 Linux kernel 中，thread 與 process 兩者都是透過 <code>task_structure</code> 這一結構來表示。</p>
<p>這邊以 POSIX<code>pthread_create()</code> 作為建立thread的範例，而 process 則是透過 <code>fork()</code>。</p>
<p><strong>pthread_create calling flow:</strong></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><code>pthread_create()</code> -&gt; <code>create_thread()</code> -&gt; <code>kernel_clone()</code></p></div></div>
<p><strong>fork calling flow:</strong></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><code>fork()</code> -&gt; <code>sys_fork()</code> -&gt; <code>kernel_clone()</code></p></div></div>
<p>‼️<!-- --> <strong>對於 <code>clone</code> 而有，兩者的差別在用來建立的參數不同</strong></p>
<p><strong>節錄自：Linux Kernel</strong></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SYSCALL_DEFINE0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">CONFIG_MMU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">kernel_clone_args</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exit_signal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SIGCHLD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">kernel_clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* can not support in nommu mode */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">EINVAL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>節錄自：POSIX <code>pthread_create()</code></strong></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> clone_flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CLONE_VM </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_FS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_FILES </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_SYSVSEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_SIGHAND </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_THREAD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_SETTLS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_PARENT_SETTID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CLONE_CHILD_CLEARTID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">TLS_DEFINE_INIT_TP</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">clone_args</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clone_flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pidfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parent_tid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">child_tid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stackaddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stacksize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> tp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>這裡來做個實驗，去透過在 <strong>/kernel/fork.c</strong> 的 <strong><code>kernel_clone()</code></strong> 中增加一段程式碼，去秀出 <code>fork()</code> 與 <code>pthread_create()</code> 在 clone 時所使用的 flags 的差別，再去看這些 flags 的定義。</p>
<p>實驗環境為 Linux kernel 6.8.1</p>
<p><strong>新增的程式碼 :</strong></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">IDN</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;&lt;CLONE_FLAGS&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__show_flag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64 flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">&lt;&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">pr_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s 0x%lx is enable\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IDN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong><code>fork()</code></strong></p>
<div class="language-= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  106.814500] &lt;CLONE_FLAGS&gt; 0x200000 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  106.815575] &lt;CLONE_FLAGS&gt; 0x1000000 is enable</span><br></span></code></pre></div></div>
<p><strong><code>pthread_create()</code></strong></p>
<div class="language-= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[   50.175439] &lt;CLONE_FLAGS&gt; 0x100 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.176710] &lt;CLONE_FLAGS&gt; 0x200 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.177968] &lt;CLONE_FLAGS&gt; 0x400 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.179192] &lt;CLONE_FLAGS&gt; 0x800 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.180385] &lt;CLONE_FLAGS&gt; 0x10000 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.181669] &lt;CLONE_FLAGS&gt; 0x40000 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.182944] &lt;CLONE_FLAGS&gt; 0x80000 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.184161] &lt;CLONE_FLAGS&gt; 0x100000 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.185443] &lt;CLONE_FLAGS&gt; 0x200000 is enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Parent here !</span><br></span></code></pre></div></div>
<p>在 <a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/sched.h#L10" target="_blank" rel="noopener noreferrer"><strong>/include/uapi/linux/sched.h</strong></a> 中定義了每一項flags，也可以參考 <a href="https://www.man7.org/linux/man-pages/man2/clone.2.html" target="_blank" rel="noopener noreferrer">clone(2) — Linux manual page</a></p>
<p>觀察上述結果，<code>pthread_create()</code> 比起 <code>fork()</code> 啟用了更多的 flags:</p>
<div class="language-= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[   50.175439] &lt;CLONE_FLAGS&gt; 0x100 is enable    // CLONE_VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.176710] &lt;CLONE_FLAGS&gt; 0x200 is enable    // CLONE_FS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.177968] &lt;CLONE_FLAGS&gt; 0x400 is enable    // CLONE_FILES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.179192] &lt;CLONE_FLAGS&gt; 0x800 is enable    // CLONE_SIGHAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.180385] &lt;CLONE_FLAGS&gt; 0x10000 is enable  // CLONE_THREAD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.181669] &lt;CLONE_FLAGS&gt; 0x40000 is enable  // CLONE_SYSVSEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   50.182944] &lt;CLONE_FLAGS&gt; 0x80000 is enable  // CLONE_SETTLS</span><br></span></code></pre></div></div>
<p>接著來一看一下這些 Flags 的含意。</p>
<p><strong>CLONE_VM</strong></p>
<blockquote>
<p><strong>The calling process and the child process run in the same memory space.</strong></p>
<p>摘錄自：Linux manual page</p>
</blockquote>
<p><strong>共享同一個 <code>mm_struct</code> 物件</strong></p>
<p>該 flag 能讓不同“操作流”在相同位址空間下執行，這也代表了 thread 與 process 之間的其中一種關係，thread 為 process 之下的一個工作流程。</p>
<p><strong>CLONE_FS</strong></p>
<blockquote>
<p><strong>If CLONE_FS is set, the caller and the child process share the same filesystem information. This includes the root of the filesystem, the current working directory, and the umask.</strong></p>
</blockquote>
<p><strong>CLONE_FILES</strong></p>
<blockquote>
<p><strong>If CLONE_FILES is set, the calling process and the child process share the same file descriptor table.</strong></p>
</blockquote>
<p><strong>CLONE_SIGHAND</strong></p>
<blockquote>
<p><strong>If CLONE_SIGHAND is set, the calling process and the child process share the same table of signal handlers.</strong></p>
</blockquote>
<p><strong>CLONE_THREAD</strong></p>
<blockquote>
<p><strong>Inserts the child into the same thread group of the parent, and forces the child to share the signal descriptor of the parent.</strong></p>
<p>摘錄自 Understanding The Linux Kernel</p>
</blockquote>
<p>上述有提到 若該flag有被設置，則會將新建立的 task 加入 parent 的 thread group。而且所有在 parent 的 thread 會共同被 signal所影響。</p>
<p>在 Linux manual page 中也有提到：</p>
<blockquote>
<p>When a clone call is made <strong>without specifying <code>CLONE_THREAD</code></strong>, then the <strong>resulting thread is placed in a new thread group</strong> whose <strong>TGID is the same as the thread&#x27;s TID</strong>. This thread is the leader of the new thread group.</p>
</blockquote>
<p><strong>以 CPU 當前在執行的 thread 與他所能存取的資源角度 :</strong></p>
<p>Process 與 Thread 在 Linux 中最大的區別，個人認為是 “位址空間” Process 擁有獨立的位址空間而 Thread 則與其它 Thraed 在同一 Process 的位址空間之下。</p>
<p><strong>對於 CPU 本身而言 :</strong></p>
<p>Process 與 Thraed 無異，構成 CPU 執行流的元素們 (如: register file 與 stack pointer 等等) 對於兩者來說是相同意義，都是透過處理器中的 register file 中的暫存器表示。</p>
<h1>Process API</h1>
<p>這裡粗略整理 process 的 API 們。</p>
<ul>
<li>fork()</li>
<li>wait()</li>
<li>exec()</li>
</ul>
<p><code>fork()</code> 與 <code>exec()</code> 在我們日常透過 shell 執行程式中有著密不可分的關係，而 <code>wait()</code> 則是與 process 執行完後的資源回收相關。</p>
<p><code>fork()</code> 在 Linux 中是基於 <code>clone()</code> 再加上特定參數來建立新的 Process，在新的 Process 誕生後基本上與建立它的 Process 接近相同，通常建立新的 Process 是為了要執行某一個 Program ，這時需要透過 <code>exec()</code> 系列的 system call 將 Program 載入。</p>
<p>我們平常在 command line 中所使用的“指令”本身就是一個執行檔(Program)，shell 在我們輸入指令後 fork 出一個新的 Process 再搭配 exec 將指令的 Program 載入。</p>
<p>至於 wait() 則是當 Process 結束後用來將剩餘未釋放的資源，像是 PCB(在Linux中為 task_structure)釋放。</p>
<h1>Reference</h1>
<ul>
<li><a href="https://bottomupcs.com/index.html" target="_blank" rel="noopener noreferrer"><strong>Computer Science from the Bottom Up</strong></a></li>
<li><a href="https://hackmd.io/@sysprog/linux-process#Linux-%E8%A8%AD%E8%A8%88%E7%9A%84-trade-off-%E5%92%8C-evolution" target="_blank" rel="noopener noreferrer"><strong>不僅是個執行單元的 Process</strong></a></li>
<li>Understanding The Linux Kernel</li>
<li><a href="https://pages.cs.wisc.edu/~remzi/OSTEP/cpu-intro.pdf" target="_blank" rel="noopener noreferrer">The Abstraction: The Process</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Linux Kernel/Process.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/FreeRTOS/Multi-core Message Buffer"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Multi-core Message Buffer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Multi-Core Programming/Log System"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Log System</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#process" class="table-of-contents__link toc-highlight">Process</a><ul><li><a href="#構成-process-的元素們" class="table-of-contents__link toc-highlight">構成 Process 的元素們</a></li><li><a href="#differ-between-new-process--parent" class="table-of-contents__link toc-highlight">Differ between new process &amp; parent</a></li></ul></li><li><a href="#thread" class="table-of-contents__link toc-highlight">Thread</a></li><li><a href="#differ-between-thread--process" class="table-of-contents__link toc-highlight">Differ between thread &amp; process</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Contect</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Mail: zung880214@gmail.com</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Media</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Falcons0214" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © Joseph Huang, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>